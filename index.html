<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç·šä¸Šç‹¼äººæ®ºï¼ˆGitHubç‰ˆï¼‰</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f2f2f2;margin:0;padding:0;}
    #container{width:90%;max-width:900px;margin:20px auto;background:#fff;padding:15px;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,0.2);}
    #playerList img{width:40px;height:40px;border-radius:50%;margin-right:5px;vertical-align:middle;}
    #playerList li{margin:5px 0;list-style:none;}
    #chatBox{height:150px;overflow-y:auto;border:1px solid #ccc;padding:5px;margin-top:5px;background:#fafafa;}
    #nightTargets button{margin:3px;padding:5px;}
    .hidden{display:none;}
  </style>
</head>
<body>
<div id="container">
  <h2>ç·šä¸Šç‹¼äººæ®º</h2>

  <div id="lobby">
    <label>åç¨±ï¼š<input type="text" id="nameInput"></label>
    <input type="file" id="avatarInput">
    <button onclick="createRoom()">å»ºç«‹æˆ¿é–“</button>
    <label>æˆ¿è™Ÿï¼š<input type="text" id="joinRoomId"></label>
    <button onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
    <h4>æˆ¿é–“åˆ—è¡¨</h4>
    <ul id="roomList"></ul>
    <button onclick="refreshRoomList()">åˆ·æ–°æˆ¿é–“åˆ—è¡¨</button>
  </div>

  <div id="game" class="hidden">
    <h3>æˆ¿é–“ <span id="roomId"></span> | ä½ : <span id="myRole">?</span></h3>
    <ul id="playerList"></ul>
    <div id="nightAction">
      <h4>å¤œæ™šè¡Œå‹•</h4>
      <div id="nightActionInfo"></div>
      <div id="nightTargets"></div>
    </div>
    <div id="voteDiv">
      <h4>æŠ•ç¥¨</h4>
      <div id="voteTargets"></div>
      <button onclick="submitMyVote()">æŠ•ç¥¨</button>
    </div>
    <div id="chatDiv">
      <h4>èŠå¤©å®¤</h4>
      <div id="chatBox"></div>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <input type="text" id="chatInput" style="flex:1;">
        <button onclick="sendChat()" style="white-space:nowrap;">é€å‡º</button>
      </div>
    </div>
    <button id="assignBtn" onclick="assignRoles()">åˆ†é…èº«åˆ†ï¼ˆæˆ¿ä¸»ï¼‰</button>
    <button id="resolveNightBtn" onclick="resolveNight()">çµæŸå¤œæ™šï¼ˆæˆ¿ä¸»ï¼‰</button>
    <button id="resolveVoteBtn" onclick="resolveVotes()">çµæŸæŠ•ç¥¨ï¼ˆæˆ¿ä¸»ï¼‰</button>
    <button id="leaveBtn" onclick="leaveRoom()">é›¢é–‹æˆ¿é–“</button>
  </div>
</div>

<script>
const API_URL = 'https://ä½ çš„å¾Œç«¯API'; // éœ€è¦è‡ªå·±éƒ¨ç½²çš„å¾Œç«¯

let state = {roomId:null, playerId:null, myVote:null};
let myRole = null;

// å–å¾—ç™»å…¥è³‡è¨Š
function getLoginInfo(){
  return {
    playId: localStorage.getItem('playId'),
    name: localStorage.getItem('playerName') || document.getElementById('nameInput').value || 'ç©å®¶'
  };
}

// å°‡ä¸Šå‚³åœ–ç‰‡è½‰æˆ DataURL
function fileToDataURL(file){
  return new Promise((resolve, reject)=>{
    if(!file){ resolve(''); return; }
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}

// å»ºç«‹æˆ¿é–“
async function createRoom(){
  const { playId, name } = getLoginInfo();
  if(!playId){ alert('å°šæœªç™»å…¥'); return; }

  const file = document.getElementById('avatarInput').files[0];
  const avatarData = await fileToDataURL(file);

  try {
    // ä¸Šå‚³ avatar
    let avatarUrl = '';
    if(avatarData){
      const uploadRes = await fetch(`${API_URL}/uploadAvatar`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({dataUrl:avatarData, filename:file.name})
      });
      const data = await uploadRes.json();
      avatarUrl = data.url;
    }

    // å»ºç«‹æˆ¿é–“
    const res = await fetch(`${API_URL}/createRoom`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name, avatarUrl, playId})
    });
    const roomData = await res.json();
    if(roomData.error){ alert(roomData.error); return; }
    enterGame(roomData.roomId, roomData.playerId);
  } catch(e){
    console.error(e);
    alert('å»ºç«‹æˆ¿é–“å¤±æ•—');
  }
}

// åŠ å…¥æˆ¿é–“
async function joinRoom(){
  const { playId, name } = getLoginInfo();
  if(!playId){ alert('å°šæœªç™»å…¥'); return; }
  const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();
  if(!roomId){ alert('è«‹è¼¸å…¥æˆ¿è™Ÿ'); return; }

  const file = document.getElementById('avatarInput').files[0];
  const avatarData = await fileToDataURL(file);

  try {
    let avatarUrl = '';
    if(avatarData){
      const uploadRes = await fetch(`${API_URL}/uploadAvatar`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({dataUrl:avatarData, filename:file.name})
      });
      const data = await uploadRes.json();
      avatarUrl = data.url;
    }

    const res = await fetch(`${API_URL}/joinRoom`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId, name, avatarUrl, playId})
    });
    const roomData = await res.json();
    if(roomData.error){ alert(roomData.error); return; }
    enterGame(roomId, roomData.playerId);
  } catch(e){
    console.error(e);
    alert('åŠ å…¥æˆ¿é–“å¤±æ•—');
  }
}

// é€²å…¥éŠæˆ²
function enterGame(roomId, playerId){
  state.roomId = roomId;
  state.playerId = playerId;

  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');
  document.getElementById('roomId').innerText = roomId;

  pollRoom();
  clearInterval(window.pollTimer);
  window.pollTimer = setInterval(pollRoom, 1500);
}
</script>
<script>
// è¼ªè©¢æˆ¿é–“ç‹€æ…‹
async function pollRoom(){
  if(!state.roomId || !state.playerId) return;
  try {
    const res = await fetch(`${API_URL}/getRoomState?roomId=${state.roomId}&playerId=${state.playerId}`);
    const data = await res.json();
    if(data.error) return;

    const players = data.players || {};
    state.phase = data.phase;
    myRole = players[state.playerId]?.role || '?';
    document.getElementById('myRole').innerText = myRole;

    // ç©å®¶åˆ—è¡¨
    const ul = document.getElementById('playerList');
    ul.innerHTML = '';
    Object.values(players).forEach(p => {
      const li = document.createElement('li');
      li.style.display = "flex";
      li.style.alignItems = "center";
      li.style.margin = "8px 0";

      const img = document.createElement('img');
      img.src = p.avatar || 'https://via.placeholder.com/40';
      img.style.width = "40px";
      img.style.height = "40px";
      img.style.borderRadius = "50%";
      img.style.marginRight = "10px";

      const textBox = document.createElement('div');
      textBox.style.display = "flex";
      textBox.style.flexDirection = "column";

      const nameDiv = document.createElement('div');
      nameDiv.textContent = p.name;

      const statusDiv = document.createElement('div');
      statusDiv.textContent = (p.alive ? 'ğŸŸ¢ å­˜æ´»' : 'âš« æ­»äº¡') + (p.role ? ` (${p.role})` : '');
      statusDiv.style.fontSize = "13px";
      statusDiv.style.color = p.alive ? "#0a0" : "#888";

      textBox.appendChild(nameDiv);
      textBox.appendChild(statusDiv);
      li.appendChild(img);
      li.appendChild(textBox);
      ul.appendChild(li);
    });

    // èŠå¤©å®¤
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';
    (data.chat || []).forEach(c => {
      const div = document.createElement('div');
      div.textContent = (c.system ? '[ç³»çµ±]' : c.name ? c.name + ': ' : '') + c.text;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;

    // ===== å¤œæ™šæ“ä½œ =====
    const nightDiv = document.getElementById('nightTargets');
    const nightInfo = document.getElementById('nightActionInfo');
    nightDiv.innerHTML = '';
    nightInfo.textContent = '';

    if((data.phase === 'rolesAssigned' || data.phase === 'night') && players[state.playerId]?.alive){
      let actionDone = false;
      const alivePlayers = Object.values(players).filter(p => p.alive && p.id !== state.playerId);

      const nightActions = {
        werewolf: 'kill',
        seer: 'check',
        doctor: 'save'
      };

      const actionType = nightActions[myRole];
      if(actionType){
        nightInfo.textContent = myRole === 'werewolf' ? 'ç‹¼äººï¼šé¸æ“‡æ”»æ“Šç›®æ¨™'
          : myRole === 'seer' ? 'é è¨€å®¶ï¼šé¸æ“‡æŸ¥é©—ç›®æ¨™'
          : 'é†«ç”Ÿï¼šé¸æ“‡å®ˆè­·ç›®æ¨™';

        alivePlayers.forEach(p => {
          const btn = document.createElement('button');
          btn.textContent = p.name;
          btn.onclick = async () => {
            await fetch(`${API_URL}/submitNightAction`,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                roomId: state.roomId,
                playerId: state.playerId,
                action: {type: actionType, targetId: p.id}
              })
            });
            nightInfo.textContent = 'å·²é¸æ“‡ç›®æ¨™ï¼š' + p.name;
            actionDone = true;
          };
          nightDiv.appendChild(btn);
        });
      } else {
        nightInfo.textContent = 'å¹³æ°‘ï¼šç„¡å¤œæ™šè¡Œå‹•';
        actionDone = true;
      }
    }

    // ===== æŠ•ç¥¨æŒ‰éˆ• =====
    const voteDiv = document.getElementById('voteTargets');
    voteDiv.innerHTML = '';
    if(data.phase === 'day'){
      Object.values(players).filter(p => p.alive && p.id !== state.playerId).forEach(p => {
        const btn = document.createElement('button');
        btn.textContent = p.name;
        btn.onclick = () => {
          state.myVote = p.id;
          alert('å·²é¸æ“‡æŠ•ç¥¨å°è±¡ï¼š' + p.name);
        };
        voteDiv.appendChild(btn);
      });
    }

  } catch(e){
    console.error(e);
  }
}

// æŠ•ç¥¨
async function submitMyVote(){
  if(!state.myVote){ alert('è«‹é¸æ“‡æŠ•ç¥¨ç›®æ¨™'); return; }
  try {
    await fetch(`${API_URL}/submitVote`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        roomId: state.roomId,
        playerId: state.playerId,
        targetId: state.myVote
      })
    });
    alert('æŠ•ç¥¨é€å‡º');
  } catch(e){
    console.error(e);
    alert('æŠ•ç¥¨å¤±æ•—');
  }
}

// åˆ†é…èº«åˆ†ï¼ˆæˆ¿ä¸»ï¼‰
async function assignRoles(){
  try {
    await fetch(`${API_URL}/assignRoles`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId: state.roomId, playerId: state.playerId})
    });
  } catch(e){ console.error(e); }
}

// çµæŸå¤œæ™šï¼ˆæˆ¿ä¸»ï¼‰
async function resolveNight(){
  try {
    await fetch(`${API_URL}/resolveNight`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId: state.roomId, playerId: state.playerId})
    });
  } catch(e){ console.error(e); }
}

// çµæŸæŠ•ç¥¨ï¼ˆæˆ¿ä¸»ï¼‰
async function resolveVotes(){
  try {
    await fetch(`${API_URL}/resolveVotes`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId: state.roomId, playerId: state.playerId})
    });
  } catch(e){ console.error(e); }
}

// èŠå¤©å®¤
async function sendChat(){
  const txt = document.getElementById('chatInput').value.trim();
  if(!txt) return;
  try {
    await fetch(`${API_URL}/postChat`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId: state.roomId, playerId: state.playerId, text: txt})
    });
    document.getElementById('chatInput').value = '';
  } catch(e){ console.error(e); }
}
</script>
<script>
// é›¢é–‹æˆ¿é–“
async function leaveRoom() {
  if(!state.roomId || !state.playerId) return;
  try {
    await fetch(`${API_URL}/leaveRoom`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({roomId: state.roomId, playerId: state.playerId})
    });
    alert("ä½ å·²é›¢é–‹æˆ¿é–“");

    // æ¸…æ‰å‰ç«¯è³‡æ–™
    state.roomId = null;
    state.playerId = null;
    state.myVote = null;
    myRole = null;

    // åˆ‡æ›ç•«é¢
    document.getElementById('game').classList.add('hidden');
    document.getElementById('lobby').classList.remove('hidden');

    // æ¸…ç©ºèŠå¤©å®¤ã€ç©å®¶åˆ—è¡¨
    document.getElementById('chatBox').innerHTML = '';
    document.getElementById('playerList').innerHTML = '';
    document.getElementById('myRole').innerText = '?';
  } catch(e){
    console.error(e);
    alert("é›¢é–‹æˆ¿é–“å¤±æ•—ï¼š" + e);
  }
}

// å–å¾—æˆ¿é–“åˆ—è¡¨
async function refreshRoomList() {
  try {
    const res = await fetch(`${API_URL}/listRooms`);
    const rooms = await res.json();
    const ul = document.getElementById('roomList');
    ul.innerHTML = '';
    if(!rooms || rooms.length===0){
      ul.innerHTML = '<li>ç›®å‰æ²’æœ‰æˆ¿é–“</li>';
      return;
    }
    rooms.forEach(r => {
      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.textContent = `æˆ¿è™Ÿ: ${r.id} | æˆ¿ä¸»: ${r.hostName} | ç©å®¶: ${r.playerCount}`;

      const btn = document.createElement('button');
      btn.textContent = 'åŠ å…¥';
      btn.onclick = ()=>joinRoomByList(r.id);
      li.appendChild(btn);
      ul.appendChild(li);
    });
  } catch(e){
    console.error(e);
  }
}

// é»æ“Šæˆ¿é–“åˆ—è¡¨åŠ å…¥
function joinRoomByList(roomId){
  document.getElementById('joinRoomId').value = roomId;
  joinRoom();
}

// åˆå§‹åŒ–æ™‚è‡ªå‹•åˆ·æ–°æˆ¿é–“åˆ—è¡¨
refreshRoomList();
setInterval(refreshRoomList, 5000);

// è¼ªè©¢æˆ¿é–“ç‹€æ…‹å®šæ™‚å™¨
setInterval(pollRoom, 1500);
</script>
